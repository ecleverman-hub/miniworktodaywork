<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlowUp Pro | èŒåœºå…¨èƒ½çœ‹æ¿ V18</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #7C83FD;
            --primary-light: #96BAFF;
            --success: #6ECB63;
            --danger: #FF6B6B;
            --warning: #FFAD60;
            --water: #56CCF2;
            --bg-gradient: linear-gradient(135deg, #f8faff 0%, #e0e7ff 100%);
            --card: rgba(255, 255, 255, 0.9);
            --text-main: #2D3250;
            --text-sub: #707793;
            --shadow: 0 12px 40px rgba(124, 131, 253, 0.12);
            --radius: 20px;
        }

        * { box-sizing: border-box; font-family: "SF Pro Display", "PingFang SC", "Hiragino Sans GB", sans-serif; }
        body { margin: 0; background: var(--bg-gradient); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* --- ä¾§è¾¹æ  --- */
        .sidebar {
            width: 280px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(30px);
            border-right: 1px solid rgba(255, 255, 255, 0.4); display: flex; flex-direction: column; padding: 30px 20px;
            height: 100vh;        /* å æ»¡å±å¹•é«˜åº¦ */
            overflow-y: auto;     /* å·¦ä¾§å…è®¸ç«–å‘æ»šåŠ¨ */
            overflow-x: hidden;   /* ç¦æ­¢æ¨ªå‘æ»šåŠ¨ */
        }
        .logo { font-size: 28px; font-weight: 900; letter-spacing: -1px; margin-bottom: 40px; padding-left: 15px; }
        .logo span { color: var(--primary); }

        .nav-group { margin-bottom: 25px; }
        .nav-label { font-size: 12px; font-weight: 700; color: #A0AEC0; margin-left: 15px; margin-bottom: 10px; text-transform: uppercase; }
        
        .nav-item {
            padding: 14px 18px; border-radius: 16px; cursor: pointer; margin-bottom: 6px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 12px; color: var(--text-sub);
        }
        .nav-item:hover { background: rgba(255, 255, 255, 0.8); transform: translateX(5px); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 10px 20px rgba(124, 131, 253, 0.3); }

        /* --- ä¸»å†…å®¹åŒº --- */
        .main { flex: 1; overflow-y: auto; padding: 40px; scroll-behavior: smooth; }
        .view-section { display: none; max-width: 1100px; margin: 0 auto; animation: slideUp 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* --- å¡ç‰‡ç¾åŒ– --- */
        .glass-card { 
            background: var(--card); border-radius: var(--radius); padding: 25px; 
            box-shadow: var(--shadow); border: 1px solid rgba(255, 255, 255, 0.6);
            margin-bottom: 25px; transition: 0.3s; position: relative;
        }
        .glass-card:hover { transform: translateY(-2px); box-shadow: 0 15px 45px rgba(124, 131, 253, 0.15); }

        /* --- å†å²é—ç•™åŒºåŸŸæ ·å¼ --- */
        .legacy-zone {
            background: rgba(255, 173, 96, 0.1); border: 1px dashed var(--warning);
            border-radius: var(--radius); padding: 15px; margin-bottom: 20px;
        }

        /* --- UI é€‚é…ä¼˜åŒ–ï¼šå­ä»»åŠ¡å®¹å™¨ --- */
        .subtask-container {
            margin-left: 20px; margin-top: 12px; padding-left: 18px;
            border-left: 2px dashed #E2E8F0; position: relative;
        }
        .subtask-item {
            display: flex; align-items: center; gap: 10px; margin-bottom: 8px;
            padding: 6px 10px; border-radius: 10px; transition: 0.2s;
        }
        .subtask-item:hover { background: rgba(124, 131, 253, 0.05); }

        /* --- å­¦ä¹ æ‰“å¡å¡ç‰‡é€‚é… --- */
        .study-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 20px; }
        .study-card { border-top: 4px solid var(--primary); }
        .progress-bar { height: 10px; background: #F1F5F9; border-radius: 6px; overflow: hidden; margin: 15px 0; border: 1px solid #E2E8F0; }
        .progress-inner { height: 100%; background: linear-gradient(90deg, var(--primary-light), var(--success)); transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        /* --- æ—¥å†å¢å¼º --- */
        .calendar-strip { display: flex; gap: 12px; overflow-x: auto; padding: 10px 5px; scrollbar-width: none; margin-bottom: 25px; }
        .date-pill {
            min-width: 70px; height: 85px; background: white; border-radius: 18px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; border: 2px solid transparent; position: relative;
        }
        .date-pill.is-today { border-color: var(--primary-light); }
        .date-pill.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 8px 20px rgba(124, 131, 253, 0.25); }

        /* --- åŸºç¡€ UI --- */
        input, select, textarea { 
            border: 1px solid #E2E8F0; padding: 12px 16px; border-radius: 14px; outline: none; 
            transition: 0.2s; background: white; width: 100%;
        }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 14px; cursor: pointer; font-weight: 700; transition: 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(124, 131, 253, 0.3); }
        .btn-ghost { background: #F8FAFF; border: 1px solid #E2E8F0; color: var(--text-sub); padding: 8px 16px; border-radius: 10px; cursor: pointer; font-size: 12px; font-weight: 600; }
        
        .heat-map { display: grid; grid-template-columns: repeat(auto-fill, minmax(16px, 1fr)); gap: 6px; }
        .heat-cell { aspect-ratio: 1; border-radius: 4px; background: rgba(124,131,253,0.06); position: relative; }
        .water-card { background: white; border-radius: 22px; padding: 20px; box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .water-wave { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--water); opacity: 0.25; transition: height 0.8s ease; }
        .tag { font-size: 11px; padding: 5px 12px; border-radius: 10px; font-weight: 700; display: inline-block; }
    
        /* --- ä»Šæ—¥è§’æ ‡ --- */
        .date-pill.is-today::after{
            content:"ä»Š";
            position:absolute;
            top:6px;
            right:6px;
            background:var(--primary);
            color:#fff;
            font-size:10px;
            padding:2px 6px;
            border-radius:8px;
            line-height:1.2;
            box-shadow:0 6px 16px rgba(124,131,253,0.25);
        }

        /* --- å­ä»»åŠ¡ UI ä¼˜åŒ– --- */
        .subtask-item { justify-content: space-between; }
        .subtask-item span { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .subtask-actions { display:flex; align-items:center; gap:10px; min-width:0; }
        .icon-del{
            color: var(--danger);
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 2px 6px;
            border-radius: 8px;
            user-select: none;
            transition: 0.2s;
        }
        .icon-del:hover{ background: rgba(255,107,107,0.12); transform: translateY(-1px); }

        /* --- å¤ç›˜åˆ—è¡¨æ“ä½œåŒº --- */
        .retro-head{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
        .retro-meta{ font-size:12px; color: var(--text-sub); margin-top: 8px; }

        /* --- åº†ç¥åŠ¨æ•ˆï¼ˆè½»é‡ï¼‰--- */
        @keyframes popIn { from{ transform: scale(0.92); opacity: 0;} to{ transform: scale(1); opacity: 1;} }

        /* --- å¼¹çª—ï¼ˆå‘¨æŠ¥é¢„è§ˆï¼‰--- */
        .modal-overlay{
            position: fixed; inset: 0; background: rgba(0,0,0,0.45);
            backdrop-filter: blur(12px);
            display:none; align-items:center; justify-content:center;
            z-index: 1200;
        }
        .modal{
            width: min(720px, 92vw);
            background: white;
            border-radius: 26px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.22);
            border: 1px solid rgba(255,255,255,0.7);
            overflow: hidden;
            animation: popIn .22s ease;
        }
        .modal-head{
            padding: 18px 22px;
            display:flex; justify-content:space-between; align-items:center;
            border-bottom: 1px solid #EEF2FF;
            background: linear-gradient(135deg, rgba(124,131,253,0.10), rgba(150,186,255,0.10));
        }
        .modal-head h3{ margin:0; font-size: 16px; letter-spacing: .2px; }
        .modal-body{ padding: 18px 22px 22px 22px; }
        .modal-actions{ display:flex; gap:10px; justify-content:flex-end; padding: 0 22px 22px 22px; }
        .btn-danger{ background: rgba(255,107,107,0.12); color: var(--danger); border:1px solid rgba(255,107,107,0.25); padding:10px 16px; border-radius: 12px; cursor:pointer; font-weight:700; }
        .btn-danger:hover{ transform: translateY(-1px); }
        .report-textarea{
            width: 100%;
            height: 330px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 13px;
            line-height: 1.55;
            border-radius: 16px;
            padding: 14px 16px;
            border: 1px solid #E2E8F0;
            background: #FBFCFF;
            resize: vertical;
        }

        /* --- å¥–ç« å¢™ --- */
        .medal-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:18px; }
        .medal-badge{
            background: rgba(255,255,255,0.92);
            border: 1px solid rgba(255,255,255,0.7);
            border-radius: 22px;
            box-shadow: var(--shadow);
            padding: 18px 18px 16px 18px;
            transition: .25s;
            position: relative;
            overflow: hidden;
        }
        .medal-badge:hover{ transform: translateY(-2px); box-shadow: 0 18px 55px rgba(124,131,253,0.16); }
        .medal-ico{
            width: 54px; height: 54px; border-radius: 18px;
            display:flex; align-items:center; justify-content:center;
            font-size: 28px;
            background: linear-gradient(135deg, rgba(124,131,253,0.16), rgba(110,203,99,0.14));
            border: 1px solid rgba(124,131,253,0.18);
        }
        .medal-row{ display:flex; gap:14px; align-items:flex-start; }
        .medal-title{ margin: 0; font-size: 15px; font-weight: 900; }
        .medal-desc{ margin: 6px 0 0 0; font-size: 12px; color: var(--text-sub); line-height: 1.5; }
        .medal-date{
            margin-top: 10px;
            display:inline-flex;
            font-size: 11px;
            font-weight: 800;
            color: rgba(45,50,80,0.65);
            padding: 5px 10px;
            border-radius: 999px;
            background: rgba(124,131,253,0.10);
            border: 1px solid rgba(124,131,253,0.16);
        }
        .medal-spark{
            position:absolute; inset:auto -30px -30px auto;
            width: 140px; height: 140px;
            background: radial-gradient(circle at 30% 30%, rgba(255,173,96,0.28), rgba(124,131,253,0.0) 60%);
            transform: rotate(12deg);
        }

    </style>
</head>
<body>

    <div id="medalOverlay" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; z-index: 1000;" onclick="this.style.display='none'">
        <div class="medal-card" style="background: white; padding: 45px; border-radius: 35px; text-align: center; max-width: 400px;">
            <div style="font-size: 90px; margin-bottom: 25px;">ğŸ†</div>
            <h2 id="medalTitle" style="margin:0; color:var(--primary); font-size:28px;">è¾¾æˆé‡Œç¨‹ç¢‘ï¼</h2>
            <p id="medalDesc" style="color:var(--text-sub); margin:15px 0 30px 0;"></p>
            <button class="btn-primary" style="width:100%">æ”¶ä¸‹è¿™ä»½è£èª‰</button>
        </div>
    </div>


    <!-- å‘¨æŠ¥é¢„è§ˆå¼¹çª— -->
    <div id="reportOverlay" class="modal-overlay" onclick="closeReportModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-head">
                <h3>ğŸ“ æœ¬å‘¨å‘¨æŠ¥é¢„è§ˆï¼ˆå¯ç¼–è¾‘ï¼‰</h3>
                <button class="btn-ghost" style="padding:8px 12px;" onclick="closeReportModal()">å…³é—­</button>
            </div>
            <div class="modal-body">
                <textarea id="reportTextarea" class="report-textarea" placeholder="è¿™é‡Œä¼šç”Ÿæˆä½ çš„å‘¨æŠ¥..."></textarea>
                <div style="margin-top:10px; font-size:12px; color:var(--text-sub);">
                    å°è´´å£«ï¼šä½ å¯ä»¥ç›´æ¥åœ¨è¿™é‡Œæ”¹å†™è¯­æ°”ã€è¡¥å……äº®ç‚¹ï¼Œç„¶åä¸€é”®å¤åˆ¶ã€‚
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-ghost" onclick="downloadReportTxt()">ä¸‹è½½ .txt</button>
                <button class="btn-primary" onclick="copyReport()">ä¸€é”®å¤åˆ¶</button>
            </div>
        </div>
    </div>


    <!-- åˆ é™¤ä»»åŠ¡å¼¹çª—ï¼ˆæ”¯æŒå¾ªç¯ä»»åŠ¡ï¼šåˆ ä¸€æ¬¡ / åˆ è§„åˆ™ï¼‰ -->
    <div id="deleteTodoOverlay" class="modal-overlay" onclick="closeDeleteTodoModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-head">
                <h3 id="deleteTodoTitle">ğŸ—‘ï¸ åˆ é™¤ä»»åŠ¡</h3>
                <button class="btn-ghost" style="padding:8px 12px;" onclick="closeDeleteTodoModal()">å…³é—­</button>
            </div>
            <div class="modal-body">
                <div id="deleteTodoDesc" style="font-size:13px; line-height:1.6; color:var(--text-sub);">
                    ç¡®è®¤åˆ é™¤è¯¥ä»»åŠ¡ï¼Ÿ
                </div>
                <div id="deleteTodoHint" style="margin-top:10px; font-size:12px; color:rgba(45,50,80,0.55); display:none;">
                    æç¤ºï¼šå¾ªç¯ä»»åŠ¡å¦‚æœåªåˆ é™¤ä»Šå¤©ï¼Œä¼šåœ¨æœªæ¥æ—¥æœŸç»§ç»­å‡ºç°ã€‚
                </div>
            </div>
            <div class="modal-actions" id="deleteTodoActions"></div>
        </div>
    </div>


    <nav class="sidebar">
        <div class="logo">GlowUp<span>Pro</span></div>
        <div class="nav-group">
            <div class="nav-label">æ¯æ—¥å·¥ä½œ</div>
            <div class="nav-item active" onclick="switchView('todo', this)">ğŸ—“ï¸ ä»»åŠ¡æ¸…å•</div>
            <div class="nav-item" onclick="switchView('retro', this)">ğŸ’¡ èŒåœºå¤ç›˜</div>
            <div class="nav-item" onclick="generateReport()" style="background: rgba(110, 203, 99, 0.1); color: var(--success);">ğŸ“ ç”Ÿæˆå‘¨æŠ¥</div>
        </div>
        <div class="nav-group">
            <div class="nav-label">è‡ªé©±åŠ¨æˆé•¿</div>
            <div class="nav-item" onclick="switchView('study', this)">ğŸ“š é•¿æœŸå­¦ä¹ </div>
            <div class="nav-item" onclick="switchView('resource', this)">ğŸ”— èµ„æºå¯¼èˆª</div>
            <div class="nav-item" onclick="switchView('stats', this)">ğŸ“ˆ æˆé•¿çƒ­åŠ›</div>
            <div class="nav-item" onclick="switchView('medals', this)">ğŸ… å¥–ç« å¢™</div>
            <div class="nav-item" onclick="switchView('backup', this)">ğŸ’¾ æ•°æ®å®‰å…¨</div>
        </div>
        <div class="widget-area" style="margin-top: auto; display: flex; flex-direction: column; gap: 15px;">
            <div class="water-card">
                <div id="waterWave" class="water-wave" style="height: 0%"></div>
                <div style="position:relative; z-index:1;">
                    <div style="font-size: 12px; font-weight: 800; color: var(--water);">DRINK WATER</div>
                    <div style="font-size: 20px; font-weight: 900; margin: 8px 0;"><span id="waterText">0</span>/8 Cups</div>
                    <div style="display:flex; gap:8px;">
                        <button onclick="changeWater(-1)" style="flex:1; border:none; background:#f0f2f5; border-radius:10px; cursor:pointer;">-</button>
                        <button onclick="changeWater(1)" style="flex:1; border:none; background:var(--water); color:white; border-radius:10px; cursor:pointer;">+</button>
                    </div>
                </div>
            </div>
            <button class="btn-ghost" onclick="exportData()">ğŸ“¤ å¯¼å‡ºå…¨é‡å¤‡ä»½</button>
        </div>
    </nav>

    <main class="main">
        <section id="view-todo" class="view-section active">
            <div class="calendar-strip" id="calendarStrip"></div>
            
            <div id="legacyContainer" style="display: none;">
                <div class="legacy-zone">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span style="font-weight:700; color:var(--warning); font-size:14px;">âš ï¸ å‘ç°å†å²æœªå®Œæˆä»»åŠ¡ (è¿‡å»3å¤©)</span>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-ghost" style="padding:4px 10px;" onclick="syncLegacy()">åŒæ­¥è‡³ä»Šæ—¥</button>
                            <button class="btn-ghost" style="padding:4px 10px;" onclick="clearLegacy()">å¿½ç•¥å…¨éƒ¨</button>
                        </div>
                    </div>
                    <div id="legacyList" style="font-size:13px; color:var(--text-sub);"></div>
                </div>
            </div>

            <div class="glass-card">
                <div style="display:flex; gap:12px; margin-bottom:15px;">
                    <input type="text" id="todoInput" placeholder="æƒ³å®Œæˆä»€ä¹ˆä»»åŠ¡ï¼Ÿ(å›è½¦æ·»åŠ )" onkeypress="if(event.key==='Enter') addTodo()">
                    <button class="btn-primary" onclick="addTodo()" style="white-space:nowrap;">æ·»åŠ ä»»åŠ¡</button>
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:20px; font-size:13px; color:var(--text-sub);">
                    <span>ğŸ” å¾ªç¯: <select id="repeatType" style="width:110px; padding:6px; margin-left:5px;"><option value="none">ä¸å¾ªç¯</option><option value="daily">æ¯å¤©</option><option value="workday">å·¥ä½œæ—¥</option><option value="weekly">æ¯å‘¨</option></select></span>
                    <span>ğŸ“… æˆªæ­¢: <input type="date" id="repeatEndDate" style="width:150px; padding:6px; margin-left:5px;"></span>
                </div>
            </div>
            <div id="todoList"></div>
        </section>

        <section id="view-study" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <h1>é•¿æœŸå­¦ä¹ é¡¹ç›®</h1>
                <button class="btn-primary" onclick="showAddStudyModal()">+ å¼€å¯æ–°è®¡åˆ’</button>
            </div>
            <div id="studyGrid" class="study-grid"></div>
        </section>

        <section id="view-retro" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <h1>èŒåœºå¤ç›˜</h1>
                <input type="text" id="searchRetro" placeholder="æœç´¢å¤ç›˜ç¬”è®°..." oninput="renderRetros()" style="width:250px;">
            </div>
            <div class="glass-card">
                <input type="text" id="retroTitle" placeholder="å¤ç›˜æ ‡é¢˜ (å¦‚ï¼šæŸé¡¹ç›®æ²Ÿé€šå¤ç›˜)" style="margin-bottom:15px;">
                <textarea id="retroContent" placeholder="å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿä¸‹æ¬¡å¦‚ä½•åšå¾—æ›´å¥½ï¼Ÿ" style="height:100px;"></textarea>
                <button class="btn-primary" onclick="addRetro()" style="margin-top:15px;">å­˜å…¥ç»éªŒåº“</button>
            </div>
            <div id="retroList"></div>
        </section>

        <section id="view-resource" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                <h1>èµ„æºå¯¼èˆª</h1>
                <input type="text" id="resSearch" placeholder="æœç´¢èµ„æº..." oninput="renderResources()" style="width:200px;">
            </div>
            <div class="glass-card">
                <div style="display:grid; grid-template-columns: 1fr 1.5fr 1fr auto; gap:12px;">
                    <input type="text" id="resName" placeholder="èµ„æºåç§°">
                    <input type="text" id="resUrl" placeholder="URL é“¾æ¥">
                    <input type="text" id="resCat" placeholder="åˆ†ç±»">
                    <button class="btn-primary" onclick="addResource()">æ”¶è—</button>
                </div>
            </div>
            <div id="resourceCats" style="display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;"></div>
            <div id="resourceList" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:20px;"></div>
        </section>

        <section id="view-stats" class="view-section">
            <h1>æˆé•¿çƒ­åŠ›å›¾</h1>
            <div class="glass-card"><div class="heat-map" id="heatMap"></div></div>
        </section>


        <section id="view-medals" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; margin-bottom:20px;">
                <div>
                    <h1 style="margin:0;">å¥–ç« å¢™</h1>
                    <div style="font-size:12px; color:var(--text-sub); margin-top:8px;">
                        è¿™é‡Œæ”¶é›†ä½ æ¯ä¸€æ¬¡ã€ŒæŠŠäº‹åšæˆã€çš„å°è¯æ®ã€‚è¶Šæ”’è¶Šè‡ªä¿¡ã€‚
                    </div>
                </div>
                <button class="btn-ghost" onclick="clearMedalWall()" title="ä¸ä¼šå½±å“ä½ çš„ä»»åŠ¡/å¤ç›˜/å­¦ä¹ æ•°æ®">æ¸…ç©ºå¥–ç« </button>
            </div>

            <div class="glass-card" style="padding:18px; display:flex; gap:14px; flex-wrap:wrap; align-items:center;">
                <div style="font-weight:900;">ğŸ“Š æœ¬æœˆæ¦‚è§ˆ</div>
                <div style="font-size:12px; color:var(--text-sub);" id="medalSummary">-</div>
            </div>

            <div id="medalGrid" class="medal-grid"></div>
            <p id="medalEmpty" style="text-align:center; color:#A0AEC0; padding:40px; display:none;">è¿˜æ²¡æœ‰å¥–ç« ï¼Œå…ˆå»å®Œæˆä¸€ä¸ªå°ç›®æ ‡å§ âœ¨</p>
        </section>


        <section id="view-backup" class="view-section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; margin-bottom:20px;">
                <div>
                    <h1 style="margin:0;">æ•°æ®å®‰å…¨</h1>
                    <div style="font-size:12px; color:var(--text-sub); margin-top:8px;">
                        è¿™é‡Œæä¾›å¯¼å‡º/å¯¼å…¥ä¸æœ¬åœ°è‡ªåŠ¨å¤‡ä»½ï¼ˆä»…ä¿å­˜åœ¨ä½ çš„æµè§ˆå™¨é‡Œï¼‰ã€‚å»ºè®®å®šæœŸå¯¼å‡ºåˆ°æœ¬æœºã€‚
                    </div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn-ghost" onclick="exportData()">ğŸ“¤ å¯¼å‡º JSON</button>
                    <button class="btn-primary" onclick="triggerImport()">ğŸ“¥ å¯¼å…¥ JSON</button>
                </div>
            </div>

            <div class="glass-card">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
                    <div>
                        <div style="font-weight:900;">ğŸ›Ÿ æœ¬åœ°è‡ªåŠ¨å¤‡ä»½</div>
                        <div style="font-size:12px; color:var(--text-sub); margin-top:6px;">
                            ç³»ç»Ÿä¼šåœ¨å†™å…¥æ•°æ®æ—¶è‡ªåŠ¨è½®æ¢ä¿å­˜æœ€è¿‘ 3 ä»½å¿«ç…§ï¼ˆé»˜è®¤æ¯ 6 å°æ—¶æœ€å¤šç”Ÿæˆ 1 ä»½ï¼‰ï¼Œç”¨äºåº”æ€¥æ¢å¤ã€‚
                        </div>
                    </div>
                    <button class="btn-ghost" onclick="rotateBackupNow()" title="ç«‹åˆ»ç”Ÿæˆä¸€ä»½å¤‡ä»½å¿«ç…§ï¼ˆä¼šè½®æ¢è¦†ç›–æœ€æ—§çš„ï¼‰">ç«‹å³å¤‡ä»½</button>
                </div>

                <div id="backupList" style="margin-top:16px; display:grid; grid-template-columns: 1fr; gap:12px;"></div>
                <div style="margin-top:14px; font-size:12px; color:rgba(45,50,80,0.55);">
                    æç¤ºï¼šæ¢å¤ä¼šè¦†ç›–å½“å‰æ•°æ®ï¼Œæ¢å¤å‰å»ºè®®å…ˆå¯¼å‡ºä¸€ä»½ JSON å¤‡ä»½ã€‚
                </div>
            </div>

            <input id="importFileInput" type="file" accept="application/json" style="display:none" onchange="handleImportFile(event)">
        </section>

    </main>

<script>
    const getToday = () => new Date().toISOString().split('T')[0];
    // ç¨³å®šæ€§ï¼šæ›´å¯é çš„å”¯ä¸€ IDï¼ˆé¿å… Date.now() æç«¯ç¢°æ’ï¼‰
    function uid(prefix='id') {
        return prefix + '_' + Date.now() + '_' + Math.random().toString(16).slice(2);
    }

    let viewingDate = getToday();
    let currentResCat = 'å…¨éƒ¨';

    let state = {
        todos: JSON.parse(localStorage.getItem('gp17_todos')) || {},
        configs: JSON.parse(localStorage.getItem('gp17_configs')) || [],
        retros: JSON.parse(localStorage.getItem('gp17_retros')) || [],
        resources: JSON.parse(localStorage.getItem('gp17_res')) || [],
        water: JSON.parse(localStorage.getItem('gp17_water')) || {},
        studyProjects: JSON.parse(localStorage.getItem('gp17_study_p')) || [],
        medals: JSON.parse(localStorage.getItem('gp17_medals')) || [],
        medalWall: JSON.parse(localStorage.getItem('gp17_medalWall')) || [],
        cycleSkips: JSON.parse(localStorage.getItem('gp17_cycleSkips')) || {}
    };

    // ç¨³å®šæ€§ï¼šä¿®å¤/å…¼å®¹æ—§æ•°æ®ç»“æ„ï¼Œé¿å…å‡çº§åå› ç±»å‹ä¸ç¬¦å¯¼è‡´æŠ¥é”™
    function normalizeState() {
        try {
            if(!state || typeof state !== 'object') state = {};
            if(!state.todos || typeof state.todos !== 'object' || Array.isArray(state.todos)) state.todos = {};
            if(!Array.isArray(state.configs)) state.configs = [];
            if(!Array.isArray(state.retros)) state.retros = [];
            if(!Array.isArray(state.resources)) state.resources = [];
            if(!state.water || typeof state.water !== 'object' || Array.isArray(state.water)) state.water = {};
            if(!Array.isArray(state.studyProjects)) state.studyProjects = [];
            if(!Array.isArray(state.medals)) state.medals = [];
            if(!Array.isArray(state.medalWall)) state.medalWall = [];
            if(!state.cycleSkips || typeof state.cycleSkips !== 'object' || Array.isArray(state.cycleSkips)) state.cycleSkips = {};
        } catch(e) { /* ignore */ }
    }
    normalizeState();


    function pruneCycleSkips(keepDays = 90) {
        try {
            if(!state.cycleSkips) return;
            const today = new Date();
            const cutoff = new Date(today);
            cutoff.setDate(cutoff.getDate() - keepDays);
            const cutoffStr = cutoff.toISOString().split('T')[0];

            Object.keys(state.cycleSkips).forEach(dateKey => {
                // ä»…å¤„ç†åˆæ³•æ—¥æœŸé”®ï¼ˆYYYY-MM-DDï¼‰
                if(!/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) return;

                if(dateKey < cutoffStr) {
                    delete state.cycleSkips[dateKey];
                    return;
                }

                // æ¸…ç†ç©º/é‡å¤
                const arr = Array.isArray(state.cycleSkips[dateKey]) ? state.cycleSkips[dateKey] : [];
                const uniq = [...new Set(arr.filter(Boolean))];
                if(uniq.length) state.cycleSkips[dateKey] = uniq;
                else delete state.cycleSkips[dateKey];
            });
        } catch(e) { /* ignore */ }
    }

    
    // æ•°æ®å®‰å…¨ï¼šè‡ªåŠ¨è½®æ¢æœ¬åœ°å¤‡ä»½ï¼ˆæœ€å¤š 3 ä»½ï¼‰ï¼Œå¹¶å¯¹é¢‘ç¹ä¿å­˜åšè½»é‡å»æŠ–
    const BACKUP_KEYS = ['gp17_backup_1','gp17_backup_2','gp17_backup_3'];
    const BACKUP_META = ['gp17_backup_meta_1','gp17_backup_meta_2','gp17_backup_meta_3'];
    const BACKUP_MIN_INTERVAL_MS = 6 * 60 * 60 * 1000; // 6 å°æ—¶æœ€å¤šç”Ÿæˆ 1 ä»½è‡ªåŠ¨å¤‡ä»½
    let _saveTimer = null;
    let _savePending = false;

    function snapshotStateString() {
        // åªä¿å­˜ state æœ¬ä½“ï¼ˆä¸å«å‡½æ•°ï¼‰ï¼Œä½“ç§¯å¯æ§ï¼›JSON.stringify å¤±è´¥åˆ™è¿”å›ç©ºä¸²
        try { return JSON.stringify(state); } catch(e) { return ''; }
    }

    function rotateBackups(force=false) {
        try {
            const now = Date.now();
            const last = parseInt(localStorage.getItem('gp17_backup_ts') || '0', 10);
            if(!force && last && (now - last) < BACKUP_MIN_INTERVAL_MS) return;

            const snap = snapshotStateString();
            if(!snap) return;

            // shift 3 <- 2 <- 1
            for(let i=2;i>=1;i--){
                const prev = localStorage.getItem(BACKUP_KEYS[i-1]);
                const prevMeta = localStorage.getItem(BACKUP_META[i-1]);
                if(prev) localStorage.setItem(BACKUP_KEYS[i], prev); else localStorage.removeItem(BACKUP_KEYS[i]);
                if(prevMeta) localStorage.setItem(BACKUP_META[i], prevMeta); else localStorage.removeItem(BACKUP_META[i]);
            }
            localStorage.setItem(BACKUP_KEYS[0], snap);
            localStorage.setItem(BACKUP_META[0], JSON.stringify({ ts: now, date: new Date(now).toISOString() }));

            localStorage.setItem('gp17_backup_ts', String(now));
        } catch(e) { /* ignore */ }
    }

    function doSaveNow() {
        try {
            // è½»é‡æ¸…ç†ï¼šé¿å… cycleSkips é•¿æœŸç´¯è®¡å˜å¤§ï¼ˆé»˜è®¤ä¿ç•™æœ€è¿‘ 90 å¤©ï¼‰
            pruneCycleSkips(90);

            // è‡ªåŠ¨å¤‡ä»½ï¼ˆèŠ‚æµï¼‰
            rotateBackups(false);

            Object.keys(state).forEach(key => {
                const storageKey = 'gp17_' + (key === 'studyProjects' ? 'study_p' : key === 'resources' ? 'res' : key);
                localStorage.setItem(storageKey, JSON.stringify(state[key]));
            });

            // æ€§èƒ½ï¼šçƒ­åŠ›å›¾æ›´æ–°ç”¨ RAF åˆå¹¶åˆ°ä¸‹ä¸€å¸§ï¼Œé¿å…çŸ­æ—¶é—´å¤šæ¬¡é‡ç»˜
            requestAnimationFrame(() => {
                try { renderHeatMap(); } catch(e) {}
            });

            // æ•°æ®å®‰å…¨é¢æ¿åŒæ­¥
            try { renderBackupList(); } catch(e) {}
        } catch(e) { /* ignore */ }
    }

    function save() {
        _savePending = true;
        if(_saveTimer) clearTimeout(_saveTimer);
        _saveTimer = setTimeout(() => {
            _saveTimer = null;
            if(!_savePending) return;
            _savePending = false;
            doSaveNow();
        }, 160); // å»æŠ–ï¼šåˆå¹¶çŸ­æ—¶é—´å†…çš„å¤šæ¬¡ä¿å­˜
    }

    // é¡µé¢å…³é—­å‰å°½é‡è½ç›˜ï¼Œé™ä½â€œæœ€åä¸€æ¬¡ç¼–è¾‘æœªä¿å­˜â€çš„æ¦‚ç‡
    window.addEventListener('beforeunload', () => {
        try{
            if(_saveTimer) { clearTimeout(_saveTimer); _saveTimer = null; }
            if(_savePending) { _savePending = false; doSaveNow(); }
        }catch(e){}
    });
// --- å¥–ç« /åº†ç¥ï¼ˆè¡¥é½ï¼šä¹‹å‰å†™äº†ä½†æœªè§¦å‘/æœªå®šä¹‰ showMedalï¼‰---
    function showMedal(title, desc) {
        const overlay = document.getElementById('medalOverlay');
        const t = document.getElementById('medalTitle');
        const d = document.getElementById('medalDesc');
        if(!overlay || !t || !d) return;
        t.textContent = title || 'è¾¾æˆé‡Œç¨‹ç¢‘ï¼';
        d.textContent = desc || '';
        // å†™å…¥å¥–ç« å¢™ï¼ˆé¿å…é‡å¤ï¼šç”¨ title+date ä½œä¸º keyï¼‰
        try{ upsertMedal((title||'').trim() + '|' + getToday(), 'ğŸ†', title, desc, getToday()); }catch(e){}
        overlay.style.display = 'flex';
        const card = overlay.querySelector('.medal-card');
        if(card) { card.style.animation = 'popIn 0.25s ease'; }
    }


    // --- å¥–ç« å¢™ï¼šå†™å…¥ä¸å±•ç¤ºï¼ˆæ–°å¢ï¼Œä¸å½±å“æ—¢æœ‰åŠŸèƒ½ï¼‰---
    function upsertMedal(key, icon, title, desc, dateStr) {
        if(!key) return;
        if(!state.medalWall) state.medalWall = [];
        const exist = state.medalWall.find(m => m.key === key);
        const payload = {
            key,
            icon: icon || 'ğŸ…',
            title: title || 'é‡Œç¨‹ç¢‘',
            desc: desc || '',
            date: dateStr || getToday()
        };
        if(exist) {
            // ä¿ç•™æ›´æ—©çš„è¾¾æˆæ—¥æœŸï¼Œä½†å…è®¸æ›´æ–°æè¿°/æ ‡é¢˜
            exist.title = payload.title;
            exist.desc = payload.desc;
            exist.icon = payload.icon;
        } else {
            state.medalWall.unshift(payload);
        }
        save();
    }

    function renderMedalWall() {
        const grid = document.getElementById('medalGrid');
        const empty = document.getElementById('medalEmpty');
        const summary = document.getElementById('medalSummary');
        if(!grid || !empty || !summary) return;

        const list = (state.medalWall || []);
        empty.style.display = list.length ? 'none' : 'block';

        // æœ¬æœˆç»Ÿè®¡
        const now = new Date();
        const ym = now.toISOString().slice(0,7);
        const monthCount = list.filter(m => (m.date || '').slice(0,7) === ym).length;
        const total = list.length;
        summary.textContent = `æœ¬æœˆæ–°å¢ ${monthCount} æšï½œç´¯è®¡ ${total} æšï½œç»§ç»­ä¿æŒè¿™è‚¡åŠ²å„¿`;

        grid.innerHTML = list.map(m => `
            <div class="medal-badge">
                <div class="medal-spark"></div>
                <div class="medal-row">
                    <div class="medal-ico">${m.icon || 'ğŸ…'}</div>
                    <div style="min-width:0;">
                        <p class="medal-title" title="${(m.title||'').replace(/"/g,'&quot;')}">${m.title || ''}</p>
                        <p class="medal-desc">${(m.desc||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</p>
                        <span class="medal-date">è¾¾æˆï¼š${m.date || ''}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function clearMedalWall() {
        if(confirm('ç¡®å®šæ¸…ç©ºå¥–ç« å¢™ï¼Ÿè¿™ä¸ä¼šå½±å“ä½ çš„ä»»åŠ¡/å¤ç›˜/å­¦ä¹ æ•°æ®ã€‚')) {
            state.medalWall = [];
            save(); renderMedalWall();
        renderBackupList();
        }
    }

    // é˜²æ­¢é‡å¤åº†ç¥ï¼šè®°å½•å½“å¤©æ˜¯å¦å·²ç»åº†ç¥è¿‡â€œä»Šæ—¥ä»»åŠ¡æ¸…é›¶â€
    function markCelebratedToday() {
        const key = 'gp17_celebrated_' + getToday();
        localStorage.setItem(key, '1');
    }
    function hasCelebratedToday() {
        const key = 'gp17_celebrated_' + getToday();
        return localStorage.getItem(key) === '1';
    }

    function checkTodayCompletion() {
        const today = getToday();
        const tasks = state.todos[today] || [];
        if(tasks.length === 0) return;
        if(tasks.every(t => t.done) && !hasCelebratedToday()) {
            showMedal("ä»Šæ—¥ä»»åŠ¡æ¸…é›¶ ğŸ‰", "æ­å–œä½ æŠŠä»Šå¤©å®‰æ’å¾—æ˜æ˜ç™½ç™½ï¼");
            markCelebratedToday();
        }
    }

    // å­¦ä¹ é¡¹ç›®å®Œæˆå¥–ç« ï¼šä»¥é¡¹ç›® id ä½œä¸ºå¥–ç«  keyï¼Œé¿å…é‡å¤å‘æ”¾
    function checkStudyMilestone(pid) {
        const p = state.studyProjects.find(x => x.id === pid);
        if(!p) return;
        const total = (p.subtasks || []).length;
        if(total === 0) return;
        const done = p.subtasks.filter(s => s.done).length;
        const progress = Math.round(done / total * 100);
        if(progress === 100 && !state.medals.includes(pid)) {
            state.medals.push(pid);
            save();
            showMedal("å­¦ä¹ ç›®æ ‡è¾¾æˆ ğŸ…", `ä½ å®Œæˆäº†ã€Œ${p.name}ã€ï¼Œå¤ªå¼ºäº†ï¼`);
        }
    }

    // --- é•¿æœŸå­¦ä¹ ï¼šåˆ é™¤å­é¡¹ç›®ï¼ˆæ–°å¢ï¼Œä¸ç ´åç°æœ‰åŠŸèƒ½ï¼‰---
    function deleteStudySub(pid, sid) {
        const p = state.studyProjects.find(x => x.id === pid);
        if(!p) return;
        if(confirm('åˆ é™¤è¿™ä¸ªç»†é¡¹ï¼Ÿ')) {
            p.subtasks = (p.subtasks || []).filter(s => s.id !== sid);
            save(); renderStudyView();
        }
    }

    // --- ç»éªŒåº“ï¼šåˆ é™¤å¤ç›˜ï¼ˆæ–°å¢ï¼‰---
    function deleteRetro(id) {
        if(confirm('åˆ é™¤è¿™æ¡å¤ç›˜ï¼Ÿ')) {
            state.retros = state.retros.filter(r => r.id !== id);
            save(); renderRetros();
        }
    }


    // --- é€»è¾‘1: é¡ºå»¶è¯†åˆ« ---
    function checkLegacyTasks() {
        const today = getToday();
        const legacy = [];
        for(let i = 1; i <= 3; i++) {
            const d = new Date(); d.setDate(d.getDate() - i);
            const dStr = d.toISOString().split('T')[0];
            if(state.todos[dStr]) {
                state.todos[dStr].forEach(t => { if(!t.done) legacy.push({ ...t, originDate: dStr }); });
            }
        }
        const container = document.getElementById('legacyContainer');
        const list = document.getElementById('legacyList');
        if(legacy.length > 0) {
            container.style.display = 'block';
            list.innerHTML = legacy.map(t => `â€¢ ${t.text} (${t.originDate})`).join('<br>');
            window.tempLegacy = legacy;
        } else {
            container.style.display = 'none';
        }
    }

    function syncLegacy() {
        if(!state.todos[getToday()]) state.todos[getToday()] = [];
        window.tempLegacy.forEach(t => {
            // é¿å…é‡å¤åŒæ­¥
            if(!state.todos[getToday()].some(exist => exist.text === t.text)) {
                state.todos[getToday()].push({ id: uid('todo'), text: t.text, done: false, subtasks: t.subtasks || [] });
            }
            // ä»åŸæ—¥æœŸåˆ é™¤ä»¥é˜²æ­¢å†æ¬¡æ£€æµ‹
            state.todos[t.originDate] = state.todos[t.originDate].filter(orig => orig.id !== t.id);
        });
        save(); renderTodos(); checkLegacyTasks();
    }

    function clearLegacy() {
        window.tempLegacy.forEach(t => {
            state.todos[t.originDate] = state.todos[t.originDate].filter(orig => orig.id !== t.id);
        });
        save(); checkLegacyTasks();
    }

    // --- ä»»åŠ¡é€»è¾‘ ---
    function addTodo() {
        const text = document.getElementById('todoInput').value;
        const type = document.getElementById('repeatType').value;
        const end = document.getElementById('repeatEndDate').value;
        if(!text) return;

        if(type === 'none') {
            if(!state.todos[viewingDate]) state.todos[viewingDate] = [];
            state.todos[viewingDate].push({ id: uid('todo'), text, done: false, subtasks: [] });
        } else {
            state.configs.push({ id: uid('conf'), text, type, start: viewingDate, end: end });
            // ç«‹åˆ»åœ¨å½“å‰æŸ¥çœ‹æ—¥æœŸç”Ÿæ•ˆï¼ˆä¿®å¤å¾ªç¯ä¸ç”Ÿæ•ˆçš„é—®é¢˜ï¼‰
            ensureCycledTasks(viewingDate);
            processCycles();
        }
        document.getElementById('todoInput').value = '';
        save(); renderTodos();
    }

    function renderTodos() {
        // ç¡®ä¿å¾ªç¯ä»»åŠ¡åœ¨å½“å‰æŸ¥çœ‹æ—¥æœŸè¢«æ­£ç¡®ç”Ÿæˆ
        ensureCycledTasks(viewingDate);
        const list = document.getElementById('todoList');
        const tasks = state.todos[viewingDate] || [];
        list.innerHTML = tasks.map((t) => `
            <div class="glass-card" style="padding:20px; ${t.done ? 'opacity:0.6;' : ''}">
                <div style="display:flex; align-items:center; gap:15px;">
                    <input type="checkbox" ${t.done ? 'checked' : ''} onchange="toggleTodo(\'${t.id}\')" style="width:20px; height:20px; accent-color:var(--primary);">
                    <div style="flex:1; font-weight:700; font-size:16px; ${t.done ? 'text-decoration:line-through;' : ''}">${t.text}</div>
                    <button class="btn-ghost" onclick="addSubtask(\'${t.id}\')">+ æ‹†è§£</button>
                    <div style="color:var(--danger); cursor:pointer; font-size:18px;" onclick="deleteTodo(\'${t.id}\')">Ã—</div>
                </div>
                ${t.subtasks && t.subtasks.length > 0 ? `<div class="subtask-container">${t.subtasks.map(s => `<div class="subtask-item"><div class="subtask-actions" style="flex:1;"><input type="checkbox" ${s.done ? 'checked' : ''} onchange="toggleSubtask(\'${t.id}\', \'${s.id}\')" style="width:18px; height:18px; accent-color:var(--primary);"><span style="flex:1; font-size:14px; ${s.done ? 'text-decoration:line-through; color:#A0AEC0;' : ''}" title="${s.text}">${s.text}</span></div><span class="icon-del" title="åˆ é™¤å­ä»»åŠ¡" onclick="deleteSubtask(\'${t.id}\', \'${s.id}\')">Ã—</span></div>`).join('')}</div>` : ''}
            </div>`).join('') || '<p style="text-align:center; color:#A0AEC0; padding:40px;">ä»Šæ—¥æ— å®‰æ’</p>';
    }

    function toggleTodo(id) { 
        const t = state.todos[viewingDate].find(x => x.id == id); 
        t.done = !t.done; save(); renderTodos(); 
        if(viewingDate === getToday()) checkTodayCompletion();
    }

    function addSubtask(todoId) {
        const txt = prompt("è¾“å…¥å­ä»»åŠ¡:");
        if(txt) {
            const t = state.todos[viewingDate].find(x => x.id == todoId);
            if(!t.subtasks) t.subtasks = [];
            t.subtasks.push({id: uid('sub'), text: txt, done: false});
            save(); renderTodos();
        }
    }

    function toggleSubtask(tid, sid) {
        const t = state.todos[viewingDate].find(x => x.id == tid);
        const s = t.subtasks.find(x => x.id == sid);
        s.done = !s.done; save(); renderTodos();
    }

    
    function deleteSubtask(tid, sid) {
        const t = (state.todos[viewingDate] || []).find(x => x.id == tid);
        if(!t || !t.subtasks) return;
        if(confirm('åˆ é™¤è¿™ä¸ªå­ä»»åŠ¡ï¼Ÿ')) {
            t.subtasks = t.subtasks.filter(s => s.id != sid);
            save(); renderTodos();
        }
    }


    // --- åˆ é™¤ä»»åŠ¡ï¼šæ™®é€šä»»åŠ¡/å¾ªç¯ä»»åŠ¡ï¼ˆå¼¹çª—é€‰æ‹©ï¼‰ ---
    let _pendingDeleteTodoId = null;

    function openDeleteTodoModal(todoId) {
        _pendingDeleteTodoId = todoId;
        const list = state.todos[viewingDate] || [];
        const t = list.find(x => x.id == todoId);
        if(!t) return;

        const overlay = document.getElementById('deleteTodoOverlay');
        const title = document.getElementById('deleteTodoTitle');
        const desc  = document.getElementById('deleteTodoDesc');
        const hint  = document.getElementById('deleteTodoHint');
        const actions = document.getElementById('deleteTodoActions');

        actions.innerHTML = '';

        // æ™®é€šä»»åŠ¡
        if(!t.confId) {
            title.textContent = 'ğŸ—‘ï¸ åˆ é™¤ä»»åŠ¡';
            desc.innerHTML = `ç¡®è®¤åˆ é™¤ <b style="color:var(--text-main);">${escapeHtml(t.text || 'è¯¥ä»»åŠ¡')}</b> å—ï¼Ÿ`;
            hint.style.display = 'none';

            actions.innerHTML = `
                <button class="btn-ghost" onclick="closeDeleteTodoModal()">å–æ¶ˆ</button>
                <button class="btn-danger" onclick="confirmDeleteTodoOnce()">ç¡®è®¤åˆ é™¤</button>
            `;
            overlay.style.display = 'flex';
            return;
        }

        // å¾ªç¯ä»»åŠ¡
        title.textContent = 'ğŸ” åˆ é™¤å¾ªç¯ä»»åŠ¡';
        desc.innerHTML = `è¿™æ˜¯ä¸€ä¸ªå¾ªç¯ä»»åŠ¡ï¼š<b style="color:var(--text-main);">${escapeHtml(t.text || '')}</b><br>è¯·é€‰æ‹©åˆ é™¤æ–¹å¼ï¼š`;
        hint.style.display = 'block';

        actions.innerHTML = `
            <button class="btn-ghost" onclick="closeDeleteTodoModal()">å–æ¶ˆ</button>
            <button class="btn-ghost" onclick="confirmDeleteTodoOnlyToday()">ä»…åˆ é™¤ä»Šå¤©</button>
            <button class="btn-danger" onclick="confirmDeleteTodoRule()">åˆ é™¤æ•´ä¸ªå¾ªç¯</button>
        `;
        overlay.style.display = 'flex';
    }

    function closeDeleteTodoModal(ev) {
        if(ev && ev.target && ev.target.id !== 'deleteTodoOverlay') return;
        document.getElementById('deleteTodoOverlay').style.display = 'none';
        _pendingDeleteTodoId = null;
    }

    // æ™®é€šä»»åŠ¡ï¼šç¡®è®¤åˆ é™¤
    function confirmDeleteTodoOnce() {
        const id = _pendingDeleteTodoId;
        if(!id) return;
        const list = state.todos[viewingDate] || [];
        state.todos[viewingDate] = list.filter(x => x.id != id);
        closeDeleteTodoModal();
        save(); renderTodos();
    }

    // å¾ªç¯ä»»åŠ¡ï¼šä»…åˆ é™¤ä»Šå¤©ï¼ˆå¹¶å†™å…¥ skipï¼Œé¿å…è‡ªåŠ¨ç”Ÿæˆå›æ¥ï¼‰
    function confirmDeleteTodoOnlyToday() {
        const id = _pendingDeleteTodoId;
        if(!id) return;

        const list = state.todos[viewingDate] || [];
        const t = list.find(x => x.id == id);
        if(!t || !t.confId) return;

        state.todos[viewingDate] = list.filter(x => x.id != id);

        if(!state.cycleSkips) state.cycleSkips = {};
        if(!state.cycleSkips[viewingDate]) state.cycleSkips[viewingDate] = [];
        if(!state.cycleSkips[viewingDate].includes(t.confId)) state.cycleSkips[viewingDate].push(t.confId);

        closeDeleteTodoModal();
        save(); renderTodos();
    }

    // å¾ªç¯ä»»åŠ¡ï¼šåˆ é™¤æ•´ä¸ªå¾ªç¯è§„åˆ™ï¼ˆæ¸…æ‰ configs + å·²ç”Ÿæˆå®ä¾‹ + skipï¼‰
    function confirmDeleteTodoRule() {
        const id = _pendingDeleteTodoId;
        if(!id) return;

        const list = state.todos[viewingDate] || [];
        const t = list.find(x => x.id == id);
        if(!t || !t.confId) return;

        const confId = t.confId;

        // ç§»é™¤è§„åˆ™
        state.configs = (state.configs || []).filter(c => c.id !== confId);

        // æ¸…æ‰æ‰€æœ‰æ—¥æœŸé‡Œå·²ç”Ÿæˆçš„è¯¥å¾ªç¯ä»»åŠ¡å®ä¾‹
        Object.keys(state.todos || {}).forEach(dateKey => {
            state.todos[dateKey] = (state.todos[dateKey] || []).filter(task => task.confId !== confId);
        });

        // æ¸…æ‰è·³è¿‡è®°å½•ï¼ˆé¿å…è„æ•°æ®ï¼‰
        Object.keys(state.cycleSkips || {}).forEach(dateKey => {
            state.cycleSkips[dateKey] = (state.cycleSkips[dateKey] || []).filter(x => x !== confId);
            if(state.cycleSkips[dateKey].length === 0) delete state.cycleSkips[dateKey];
        });

        closeDeleteTodoModal();
        save(); renderTodos();
    }

    // å…¼å®¹ä½ åŸæ¥çš„è°ƒç”¨ï¼šrenderTodos é‡Œä»ç„¶æ˜¯ deleteTodo(id)
    function deleteTodo(id) {
        openDeleteTodoModal(id);
    }

    // ç®€å•è½¬ä¹‰ï¼ˆç”¨äºå¼¹çª—å±•ç¤ºï¼‰
    function escapeHtml(str) {
        return String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
    }
// --- èµ„æºå¯¼èˆªé€»è¾‘ (æ–°å¢åˆ é™¤) ---
    function addResource() {
        const name = document.getElementById('resName').value;
        const url = document.getElementById('resUrl').value;
        const cat = document.getElementById('resCat').value || 'æœªåˆ†ç±»';
        if(name && url) { state.resources.push({ id: Date.now(), name, url, cat }); save(); renderResources(); document.getElementById('resName').value=''; document.getElementById('resUrl').value=''; document.getElementById('resCat').value=''; }
    }

    function deleteResource(id) {
        if(confirm('ç¡®å®šç§»é™¤æ­¤æ”¶è—ï¼Ÿ')) { state.resources = state.resources.filter(r => r.id !== id); save(); renderResources(); }
    }

    function renderResources() {
        const cats = ['å…¨éƒ¨', ...new Set(state.resources.map(r => r.cat))];
        document.getElementById('resourceCats').innerHTML = cats.map(c => `<span class="btn-ghost ${currentResCat === c ? 'active' : ''}" style="margin-right:5px;${currentResCat===c?'background:var(--primary);color:white;':''}" onclick="currentResCat='${c}';renderResources()">${c}</span>`).join('');
        const kw = (document.getElementById('resSearch')?.value || '').toLowerCase();
        document.getElementById('resourceList').innerHTML = state.resources.filter(r => (currentResCat === 'å…¨éƒ¨' || r.cat === currentResCat) && r.name.toLowerCase().includes(kw))
            .map(r => `<div class="glass-card" style="padding:15px; display:flex; flex-direction:column; justify-content:space-between;">
                <div>
                    <span class="tag" style="background:#E0F2FE; color:#0369A1; margin-bottom:10px;">${r.cat}</span>
                    <a href="${r.url}" target="_blank" style="text-decoration:none; color:var(--text-main); font-weight:700; display:block;">${r.name}</a>
                </div>
                <div style="text-align:right; margin-top:10px;">
                    <span style="color:var(--danger); cursor:pointer; font-size:12px;" onclick="deleteResource(${r.id})">åˆ é™¤</span>
                </div>
            </div>`).join('');
    }

    // --- çƒ­åŠ›å›¾é—­ç¯é€»è¾‘ (æƒé‡å¤åˆ) ---
    function renderHeatMap() {
        const map = document.getElementById('heatMap'); map.innerHTML = '';
        for (let i = 140; i >= 0; i--) {
            const d = new Date(); d.setDate(d.getDate() - i); const k = d.toISOString().split('T')[0];
            
            // æƒé‡è®¡ç®—ï¼šä»»åŠ¡å®Œæˆ(2åˆ†/ä¸ª) + å¤ç›˜(3åˆ†/ä¸ª) + å­¦ä¹ è®°å½•(1åˆ†/ä¸ª)
            let score = 0;
            score += (state.todos[k] || []).filter(t => t.done).length * 2;
            score += state.retros.filter(r => r.date === k).length * 3;
            state.studyProjects.forEach(p => { if(p.logs.includes(k)) score += 2; });

            const cell = document.createElement('div'); cell.className = 'heat-cell';
            if(score > 0) cell.style.background = `rgba(124, 131, 253, ${Math.min(1, score * 0.15 + 0.1)})`;
            cell.title = `${k} : èƒ½é‡å€¼ ${score}`; 
            map.appendChild(cell);
        }
    }

    // --- é•¿æœŸå­¦ä¹ é€»è¾‘ ---
    function showAddStudyModal() {
        const name = prompt("é¡¹ç›®åç§°:");
        if(name) { state.studyProjects.push({ id: Date.now(), name, subtasks: [], logs: [] }); save(); renderStudyView(); }
    }

    
    function renderStudyView() {
        document.getElementById('studyGrid').innerHTML = state.studyProjects.map(p => {
            const total = (p.subtasks || []).length;
            const done = (p.subtasks || []).filter(s=>s.done).length;
            const progress = total ? Math.round((done/total)*100) : 0;

            const subHtml = (p.subtasks || []).map(s => `
                <div class="subtask-item">
                    <div class="subtask-actions" style="flex:1;">
                        <input type="checkbox" ${s.done ? 'checked' : ''} onchange="toggleStudySub(${p.id}, ${s.id})" style="width:18px; height:18px; accent-color:var(--primary);">
                        <span style="${s.done ? 'text-decoration:line-through; color:#A0AEC0;' : ''}" title="${s.text}">${s.text}</span>
                    </div>
                    <span class="icon-del" title="åˆ é™¤ç»†é¡¹" onclick="deleteStudySub(${p.id}, ${s.id})">Ã—</span>
                </div>
            `).join('');

            return `<div class="glass-card study-card">
                <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
                    <div style="min-width:0;">
                        <h3 style="margin:0 0 6px 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${p.name}">${p.name}</h3>
                        <div style="font-size:12px; color:var(--text-sub); font-weight:700;">è¿›åº¦ï¼š${progress}%ï¼ˆ${done}/${total || 0}ï¼‰</div>
                    </div>
                    <div style="display:flex; gap:10px; flex-shrink:0;">
                        <button class="btn-ghost" onclick="addStudySub(${p.id})">+ ç»†é¡¹</button>
                        <button class="btn-ghost" style="color:var(--danger)" onclick="deleteStudy(${p.id})">æ”¾å¼ƒ</button>
                    </div>
                </div>

                <div class="progress-bar"><div class="progress-inner" style="width:${progress}%"></div></div>

                ${total ? `<div style="margin-top:10px;">${subHtml}</div>` : `<p style="color:#A0AEC0; font-size:13px; margin:12px 0 0 0;">è¿˜æ²¡æœ‰ç»†é¡¹ï¼Œå…ˆç‚¹ã€Œ+ ç»†é¡¹ã€æ‹†è§£ä¸€ä¸‹å§</p>`}
            </div>`;
        }).join('');
    }

    function toggleStudySub(pid, sid) {
        const p = state.studyProjects.find(x => x.id === pid);
        const s = p.subtasks.find(x => x.id === sid);
        s.done = !s.done;
        if(s.done) { if(!p.logs.includes(getToday())) p.logs.push(getToday()); }
        save(); renderStudyView();
        checkStudyMilestone(pid);
        }

    function addStudySub(pid) {
        const txt = prompt("ç»†é¡¹å†…å®¹:");
        if(txt) { state.studyProjects.find(x=>x.id===pid).subtasks.push({id:Date.now(), text:txt, done:false}); save(); renderStudyView(); }
    }

    function deleteStudy(id) { if(confirm('ç¡®å®šæ”¾å¼ƒï¼Ÿ')) { state.studyProjects = state.studyProjects.filter(p=>p.id!==id); save(); renderStudyView(); } }

    // --- åŸºç¡€è¾…åŠ© ---
    
    function renderAll(){
        try{ renderCalendar(); }catch(e){}
        try{ renderTodos(); }catch(e){}
        try{ renderRetros(); }catch(e){}
        try{ renderResources(); }catch(e){}
        try{ renderStudyView(); }catch(e){}
        try{ renderHeatMap(); }catch(e){}
        try{ renderMedalWall();
        renderBackupList(); }catch(e){}
        try{ renderBackupList(); }catch(e){}
            }

function switchView(id, el) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + id).classList.add('active');
        if(id === 'medals') renderMedalWall();
        renderBackupList();
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }

    function renderCalendarStrip() {
        const strip = document.getElementById('calendarStrip'); const today = getToday(); strip.innerHTML = '';
        for(let i = -3; i <= 10; i++) {
            const d = new Date(); d.setDate(d.getDate() + i); const dStr = d.toISOString().split('T')[0];
            const pill = document.createElement('div'); pill.className = `date-pill ${dStr === viewingDate ? 'active' : ''} ${dStr === today ? 'is-today' : ''}`;
            pill.innerHTML = `<span style="font-size:12px; opacity:0.8;">${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]}</span><b style="font-size:20px;">${d.getDate()}</b>`;
            pill.onclick = () => { viewingDate = dStr; renderCalendarStrip(); renderTodos(); };
            strip.appendChild(pill);
        }
    }


    // --- å¾ªç¯ä»»åŠ¡ç”Ÿæˆï¼ˆä¿®å¤ï¼šæ”¯æŒåœ¨ä»»æ„æ—¥æœŸè§†å›¾ç”Ÿæ•ˆï¼‰---
    function ensureCycledTasks(dateStr) {
        const target = dateStr || getToday();
        const dow = new Date(target).getDay();
        (state.configs || []).forEach(conf => {
            if (target >= conf.start && (!conf.end || target <= conf.end)) {
                const startDow = new Date(conf.start).getDay();
                const match =
                    (conf.type === 'daily') ||
                    (conf.type === 'workday' && dow >= 1 && dow <= 5) ||
                    (conf.type === 'weekly' && dow === startDow);

                if(match) {
                    // âœ… å¦‚æœç”¨æˆ·é€‰æ‹©â€œä»…åˆ é™¤ä»Šå¤©è¿™ä¸€æ¬¡â€ï¼Œå°±ä¸è¦å†ç”Ÿæˆ
                    const skipped = (state.cycleSkips && state.cycleSkips[target] && state.cycleSkips[target].includes(conf.id));
                    if(skipped) return;

                    if(!state.todos[target]) state.todos[target] = [];
                    // ç”¨ confId é˜²é‡ï¼Œé¿å…åŒä¸€å¤©é‡å¤å¡å…¥
                    if(!state.todos[target].some(t => t.confId === conf.id)) {
                        state.todos[target].push({
                            id: uid('todo'),
                            confId: conf.id,
                            text: conf.text,
                            done: false,
                            subtasks: []
                        });
                    }
                }
            }
        });
    }

    function processCycles() {
        ensureCycledTasks(getToday());
    }

    function addRetro() {
        const title = document.getElementById('retroTitle').value; const content = document.getElementById('retroContent').value;
        if(title && content) { state.retros.unshift({ title, content, date: getToday(), id: Date.now() }); save(); renderRetros();
            // å¤ç›˜å¥–ç« ï¼šå½“å¤©é¦–ç¯‡
            const todayCount = state.retros.filter(r => r.date === getToday()).length;
            if(todayCount === 1) showMedal('å¤ç›˜æ‰“å¡ ğŸ§ ', 'ä»Šå¤©ä¹Ÿåœ¨è®¤çœŸå˜å¼ºã€‚');
            document.getElementById('retroTitle').value = ''; document.getElementById('retroContent').value = ''; }
    }

    
    function renderRetros() {
        const kw = document.getElementById('searchRetro').value.toLowerCase();
        const filtered = state.retros.filter(r => r.title.toLowerCase().includes(kw) || r.content.toLowerCase().includes(kw));

        document.getElementById('retroList').innerHTML = filtered.length ? filtered
            .map(r => `
                <div class="glass-card">
                    <div class="retro-head">
                        <div style="min-width:0;">
                            <h4 style="margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${r.title}">${r.title}</h4>
                            <div class="retro-meta">${r.date}</div>
                        </div>
                        <span class="btn-ghost" style="padding:6px 10px; color:var(--danger);" onclick="deleteRetro(${r.id})">åˆ é™¤</span>
                    </div>
                    <p style="white-space:pre-wrap; margin:12px 0 0 0; color:var(--text-main);">${r.content}</p>
                </div>
            `).join('')
            : '<p style="text-align:center; color:#A0AEC0; padding:40px;">æš‚æ— å¤ç›˜è®°å½•</p>';
    }

    function changeWater(v) { const t = getToday(); state.water[t] = Math.max(0, Math.min(8, (state.water[t] || 0) + v)); save(); renderWater(); }
    function renderWater() { const c = state.water[getToday()] || 0; document.getElementById('waterText').innerText = c; document.getElementById('waterWave').style.height = (c/8*100) + '%'; }

    

    // --- å‘¨æŠ¥å¼¹çª—é¢„è§ˆï¼ˆæ–°å¢ï¼šæ›¿ä»£ä»…å¤åˆ¶æç¤ºï¼‰---
    function openReportModal(text) {
        const overlay = document.getElementById('reportOverlay');
        const ta = document.getElementById('reportTextarea');
        if(!overlay || !ta) return;
        ta.value = text || '';
        overlay.style.display = 'flex';
        setTimeout(()=>{ ta.focus(); ta.setSelectionRange(0,0); }, 50);
    }
    function closeReportModal(e) {
        if(e && e.target && e.target.id !== 'reportOverlay') return;
        const overlay = document.getElementById('reportOverlay');
        if(overlay) overlay.style.display = 'none';
    }
    function copyReport() {
        const ta = document.getElementById('reportTextarea');
        if(!ta) return;
        navigator.clipboard.writeText(ta.value || '').then(() => {
            showMedal('å‘¨æŠ¥å·²å¤åˆ¶ âœ…', 'å»å·¥ä½œç¾¤/é‚®ä»¶é‡Œä¸€é”®ç²˜è´´å§ï½');
        });
    }
    function downloadReportTxt() {
        const ta = document.getElementById('reportTextarea');
        const content = (ta && ta.value) ? ta.value : '';
        const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `å‘¨æŠ¥_${getToday()}.txt`;
        a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    }

    function generateReport() {
        const last7Days = Array.from({length: 7}, (_, i) => {
            const d = new Date(); d.setDate(d.getDate() - i);
            return d.toISOString().split('T')[0];
        }).reverse();

        // 1) ä»»åŠ¡å®Œæˆç»Ÿè®¡
        const doneTasksByDay = {};
        let doneTasks = [];
        let createdTasks = 0;
        last7Days.forEach(date => {
            const dayTasks = state.todos[date] || [];
            createdTasks += dayTasks.length;
            const done = dayTasks.filter(t => t.done).map(t => t.text);
            doneTasksByDay[date] = done.length;
            doneTasks.push(...done);
        });

        // 2) å­¦ä¹ æ‰“å¡ç»Ÿè®¡ï¼ˆæŒ‰å¤©å»é‡ï¼‰
        const studyDays = new Set();
        state.studyProjects.forEach(p => (p.logs || []).forEach(d => { if(last7Days.includes(d)) studyDays.add(d); }));

        // 3) å¤ç›˜ç»Ÿè®¡
        const retros = state.retros.filter(r => last7Days.includes(r.date));

        // 4) è¶‹åŠ¿ç®€è¿°ï¼ˆå¯¹æ¯”å‰3å¤© vs å3å¤©çš„å®Œæˆé‡ï¼‰
        const firstHalf = last7Days.slice(0,3).reduce((a,d)=>a+(doneTasksByDay[d]||0),0);
        const secondHalf = last7Days.slice(4,7).reduce((a,d)=>a+(doneTasksByDay[d]||0),0);
        let trend = "ç¨³å®šè¾“å‡º";
        if(secondHalf > firstHalf + 1) trend = "åç¨‹åŠ é€Ÿ";
        else if(secondHalf + 1 < firstHalf) trend = "å‰é«˜åä½ï¼ˆå¯ä¼˜åŒ–èŠ‚å¥ï¼‰";

        // Top 8
        const topList = doneTasks.slice(0,8).map(t=>'- ' + t).join('\n') || '- ï¼ˆæœ¬å‘¨æš‚æ— å·²å®Œæˆä»»åŠ¡è®°å½•ï¼‰';

        const report =
`ã€æœ¬å‘¨å‘¨æŠ¥æ‘˜è¦ã€‘
âœ… å®Œæˆä»»åŠ¡ï¼š${doneTasks.length} é¡¹ï¼ˆåˆ›å»º ${createdTasks} é¡¹ï¼‰
ğŸ“š å­¦ä¹ æ‰“å¡ï¼š${studyDays.size} å¤©
ğŸ’¡ å¤ç›˜æ²‰æ·€ï¼š${retros.length} ç¯‡
ğŸ“ˆ è¡ŒåŠ¨åŠ›è¶‹åŠ¿ï¼š${trend}

é‡ç‚¹å®Œæˆï¼š
${topList}

å¤ç›˜ä¸»é¢˜ï¼ˆå¯é€‰ï¼‰ï¼š
${retros.slice(0,4).map(r => '- ' + r.title).join('\n') || '- ï¼ˆæœ¬å‘¨æš‚æ— å¤ç›˜ï¼‰'}
`;

        // æ‰“å¼€å¼¹çª—é¢„è§ˆï¼ˆå¯ç¼–è¾‘/å¤åˆ¶/ä¸‹è½½ï¼‰
        openReportModal(report);
        // ä¹Ÿé¡ºæ‰‹å¤åˆ¶ä¸€ä»½ï¼Œé¿å…ç”¨æˆ·å¿˜è®°
        navigator.clipboard.writeText(report).catch(()=>{});
    }


    
    // --- æ•°æ®å®‰å…¨ï¼šå¯¼å…¥/å¯¼å‡º JSON & å¤‡ä»½æ¢å¤ï¼ˆæ–°å¢ï¼Œä¸å½±å“æ—¢æœ‰åŠŸèƒ½ï¼‰ ---
    function triggerImport() {
        const inp = document.getElementById('importFileInput');
        if(inp) inp.click();
    }

    function handleImportFile(evt) {
        try{
            const file = evt.target.files && evt.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try{
                    const data = JSON.parse(String(reader.result || '{}'));
                    if(!data || typeof data !== 'object') throw new Error('æ ¼å¼ä¸æ­£ç¡®');

                    // æ¢å¤å‰å…ˆè‡ªåŠ¨åšä¸€æ¬¡å¤‡ä»½ï¼Œä¾¿äºå›æ»š
                    try{ rotateBackups(true); }catch(e){}

                    state = data;
                    normalizeState();
                    doSaveNow();
                    renderAll();
                    alert('å¯¼å…¥æˆåŠŸï¼šå·²è¦†ç›–å½“å‰æ•°æ®ã€‚');
                }catch(e){
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + (e.message || 'æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„ JSON å¤‡ä»½'));
                }finally{
                    evt.target.value = '';
                }
            };
            reader.readAsText(file, 'utf-8');
        }catch(e){
            alert('å¯¼å…¥å¤±è´¥ï¼šè¯»å–æ–‡ä»¶å‡ºé”™');
        }
    }

    function readBackupSlot(i){
        try{
            const snap = localStorage.getItem(BACKUP_KEYS[i]);
            const metaRaw = localStorage.getItem(BACKUP_META[i]);
            const meta = metaRaw ? JSON.parse(metaRaw) : null;
            return { snap, meta };
        }catch(e){ return { snap:null, meta:null }; }
    }

    function restoreBackupSlot(i){
        const slot = readBackupSlot(i);
        if(!slot.snap) { alert('è¯¥å¤‡ä»½æ§½ä¸ºç©º'); return; }
        if(!confirm('ç¡®å®šç”¨è¯¥å¤‡ä»½æ¢å¤ï¼Ÿè¿™ä¼šè¦†ç›–å½“å‰æ•°æ®ã€‚å»ºè®®å…ˆå¯¼å‡ºä¸€ä»½ JSONã€‚')) return;
        try{
            // æ¢å¤å‰å†åšä¸€æ¬¡å¤‡ä»½ï¼Œä¾¿äºå›æ»š
            rotateBackups(true);

            state = JSON.parse(slot.snap);
            normalizeState();
            doSaveNow();
            renderAll();
            alert('å·²æ¢å¤å¤‡ä»½ã€‚');
        }catch(e){
            alert('æ¢å¤å¤±è´¥ï¼šå¤‡ä»½å†…å®¹æŸåæˆ–ä¸å…¼å®¹');
        }
    }

    function clearBackupSlot(i){
        if(!confirm('ç¡®å®šæ¸…ç©ºè¯¥å¤‡ä»½æ§½ï¼Ÿ')) return;
        try{
            localStorage.removeItem(BACKUP_KEYS[i]);
            localStorage.removeItem(BACKUP_META[i]);
            renderBackupList();
        }catch(e){}
    }

    function rotateBackupNow(){
        try{ rotateBackups(true); renderBackupList(); alert('å·²ç”Ÿæˆå¤‡ä»½å¿«ç…§'); }catch(e){ alert('å¤‡ä»½å¤±è´¥'); }
    }

    function fmtBackupMeta(meta){
        try{
            if(!meta) return 'æœªçŸ¥æ—¶é—´';
            const d = meta.date ? new Date(meta.date) : (meta.ts ? new Date(meta.ts) : null);
            if(!d) return 'æœªçŸ¥æ—¶é—´';
            return d.toLocaleString();
        }catch(e){ return 'æœªçŸ¥æ—¶é—´'; }
    }

    function renderBackupList(){
        const wrap = document.getElementById('backupList');
        if(!wrap) return;
        const rows = [0,1,2].map(i => {
            const { snap, meta } = readBackupSlot(i);
            const label = 'å¤‡ä»½ ' + (i+1);
            const time = snap ? fmtBackupMeta(meta) : 'ï¼ˆç©ºï¼‰';
            const size = snap ? (Math.round((snap.length/1024)*10)/10 + ' KB') : '-';
            return `
                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; padding:14px 16px; border:1px solid #E2E8F0; border-radius:16px; background:#fff;">
                    <div>
                        <div style="font-weight:900;">${label}</div>
                        <div style="font-size:12px; color:var(--text-sub); margin-top:6px;">æ—¶é—´ï¼š${time} ï½œ ä½“ç§¯ï¼š${size}</div>
                    </div>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn-ghost" onclick="restoreBackupSlot(${i})" ${snap ? '' : 'disabled'}>æ¢å¤</button>
                        <button class="btn-ghost" onclick="clearBackupSlot(${i})" ${snap ? '' : 'disabled'}>æ¸…ç©º</button>
                    </div>
                </div>
            `;
        }).join('');
        wrap.innerHTML = rows;
    }

function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
        const a = document.createElement('a'); a.href = dataStr; a.download = "glowup_v18_backup.json"; a.click();
    }

    

    // --- æ•°æ®å®‰å…¨ï¼šå¯¼å…¥å¤‡ä»½ / æ¢å¤è‡ªåŠ¨å¤‡ä»½ ---
    function flushSaveNow() {
        try{
            if(typeof doSaveNow === 'function') {
                if(_saveTimer) { clearTimeout(_saveTimer); _saveTimer = null; }
                if(_savePending) _savePending = false;
                doSaveNow();
            } else {
                // fallback
                Object.keys(state).forEach(key => {
                    const storageKey = 'gp17_' + (key === 'studyProjects' ? 'study_p' : key === 'resources' ? 'res' : key);
                    localStorage.setItem(storageKey, JSON.stringify(state[key]));
                });
            }
        }catch(e){}
    }

    function importData() {
        const input = document.getElementById('backupFileInput');
        if(!input) { alert('æœªæ‰¾åˆ°å¯¼å…¥æ§ä»¶'); return; }
        input.value = '';
        input.onchange = (e) => {
            const file = e.target.files && e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const obj = JSON.parse(String(reader.result || '{}'));
                    if(!obj || typeof obj !== 'object') throw new Error('invalid');
                    state = obj;
                    if(typeof normalizeState === 'function') normalizeState();
                    flushSaveNow();
                    // å…¨é‡åˆ·æ–°
                    try{ processCycles(); }catch(e){}
                    try{ checkLegacyTasks(); }catch(e){}
                    try{ renderCalendarStrip(); }catch(e){}
                    try{ renderTodos(); }catch(e){}
                    try{ renderRetros(); }catch(e){}
                    try{ renderStudyView(); }catch(e){}
                    try{ renderResources(); }catch(e){}
                    try{ renderWater(); }catch(e){}
                    try{ renderHeatMap(); }catch(e){}
                    try{ renderMedalWall(); }catch(e){}
                    try{ checkTodayCompletion(); }catch(e){}
                    alert('âœ… å¯¼å…¥æˆåŠŸï¼šå·²æ¢å¤æ•°æ®ã€‚');
                } catch(err) {
                    alert('âŒ å¯¼å…¥å¤±è´¥ï¼šå¤‡ä»½æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚');
                }
            };
            reader.readAsText(file, 'utf-8');
        };
        input.click();
    }

    function restoreLatestBackup() {
        try {
            const raw = localStorage.getItem('gp17_backup_1');
            if(!raw) { alert('æš‚æ— å¯ç”¨çš„è‡ªåŠ¨å¤‡ä»½ã€‚'); return; }
            if(!confirm('ç¡®å®šæ¢å¤æœ€è¿‘ä¸€æ¬¡è‡ªåŠ¨å¤‡ä»½ï¼Ÿå°†è¦†ç›–å½“å‰æ•°æ®ã€‚')) return;
            const obj = JSON.parse(raw);
            if(!obj || typeof obj !== 'object') throw new Error('invalid');
            state = obj;
            if(typeof normalizeState === 'function') normalizeState();
            flushSaveNow();
            // å…¨é‡åˆ·æ–°
            try{ processCycles(); }catch(e){}
            try{ checkLegacyTasks(); }catch(e){}
            try{ renderCalendarStrip(); }catch(e){}
            try{ renderTodos(); }catch(e){}
            try{ renderRetros(); }catch(e){}
            try{ renderStudyView(); }catch(e){}
            try{ renderResources(); }catch(e){}
            try{ renderWater(); }catch(e){}
            try{ renderHeatMap(); }catch(e){}
            try{ renderMedalWall(); }catch(e){}
            try{ checkTodayCompletion(); }catch(e){}
            alert('âœ… å·²æ¢å¤æœ€è¿‘è‡ªåŠ¨å¤‡ä»½ã€‚');
        } catch(e) {
            alert('âŒ æ¢å¤å¤±è´¥ï¼šè‡ªåŠ¨å¤‡ä»½ä¸å¯ç”¨ã€‚');
        }
    }

window.onload = () => { 
        processCycles(); 
        checkLegacyTasks();
        renderCalendarStrip(); 
        renderTodos(); 
        renderRetros(); 
        renderStudyView(); 
        renderResources(); 
        renderWater(); 
        renderHeatMap(); 
        renderMedalWall();
        renderBackupList();
        checkTodayCompletion();
    };
</script>
<input id="backupFileInput" type="file" accept="application/json" style="display:none" />
</body>
</html>
